#!/bin/bash
set -euo pipefail

if ! command -v biey &> /dev/null
then
    ERR_MESSAGE="Bie CLI tool not installed.\nPlease install the CLI in Buildkite agent first.\nFor more information-\nhttps://github.com/respond-io/buildkite-iac-executor"
    ERR_MESSAGE_HTML="ðŸ”´ <b>Bie CLI tool not installed.</b><br>Please install the CLI in Buildkite agent first.<br>For more information check <a href=\"https://github.com/respond-io/buildkite-iac-executor#installation\">Installtion Guide</a>"
    buildkite-agent annotate "$ERR_MESSAGE_HTML"
    echo -e $ERR_MESSAGE
    exit 1
else
    echo "Bie command found"
fi

TYPE="$BUILDKITE_PLUGIN_BUILDKITE_FILE_COUNTER_TYPE"
NAME="$BUILDKITE_PLUGIN_BUILDKITE_FILE_COUNTER_NAME"
STACK="$BUILDKITE_PLUGIN_BUILDKITE_FILE_COUNTER_STACK"

echo "${TYPE} || ${NAME} || ${STACK}"

PATTERN="$BUILDKITE_PLUGIN_BUILDKITE_FILE_COUNTER_PATTERN"

echo "--- :1234: Counting the number of files"

COUNT=$(find . -name "$PATTERN" | wc -l)

echo "Found ${COUNT} files matching ${PATTERN}"

buildkite-agent annotate "Found ${COUNT} files matching ${PATTERN}"
